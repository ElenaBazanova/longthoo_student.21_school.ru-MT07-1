## Уровни балансировки
Процедура балансировки осуществляется при помощи целого комплекса алгоритмов и методов, соответствующим следующим уровням модели OSI:

- сетевому;
- транспортному;
- прикладному.

**Балансировка на сетевом уровне**
Балансировка на сетевом уровне предполагает решение следующей задачи: нужно сделать так, чтобы за один конкретный IP-адрес сервера отвечали разные физические машины. Такая балансировка может осуществляться с помощью множества разнообразных способов.

- **DNS-балансировка.**
    На одно доменное имя выделяется несколько IP-адресов. Сервер, на который будет направлен клиентский запрос, обычно определяется с помощью алгоритма Round Robin.
- **Построение NLB-кластера.**
    При использовании этого способа серверы объединяются в кластер, состоящий из входных и вычислительных узлов. Распределение нагрузки осуществляется при помощи специального алгоритма. Используется в решениях от компании Microsoft.
- **Балансировка по IP с использованием дополнительного маршрутизатора.**
- **Балансировка по территориальному признаку** осуществляется путём размещения одинаковых сервисов с одинаковыми адресами в территориально различных регионах Интернета. Балансировка по территориальному признаку также используется во многих CDN.

**Балансировка на транспортном уровне**
Самый простой вид балансировки: клиент обращается к балансировщику, тот перенаправляет запрос одному из серверов, который и будет его обрабатывать. Выбор сервера, на котором будет обрабатываться запрос, может осуществляться в соответствии с самыми разными алгоритмами: путём простого кругового перебора, путём выбора наименее загруженного сервера из пула и т.п.
Иногда балансировку на транспортном уровне сложно отличить от балансировки на сетевом уровне.

К сетевому уровню относятся решения, которые не терминируют на себе пользовательские сессии. Они просто перенаправляют трафик и не работают в проксирующем режиме.
На сетевом уровне балансировщик просто решает, на какой сервер передавать пакеты. Сессию с клиентом осуществляет сервер.

На транспортном уровене общение с клиентом замыкается на балансировщике, который работает как прокси. Он взаимодействует с серверами от своего имени, передавая информацию о клиенте в дополнительных данных и заголовках.

**Балансировка на прикладном уровне**
При балансировке на прикладном уровне балансировщик работает в режиме «умного прокси».Происходит анализ клиентских запросов и перенаправление их на разные серверы в зависимости от характера запрашиваемого контента. Так работает, например, веб-сервер Nginx, распределяя запросы между фронтендом и бэкендом. За балансировку в Nginx отвечает модуль Upstream.

В качестве ещё одного примера инструмента балансировки на прикладном уровне можно привести pgpool — промежуточный слой между клиентом и сервером СУБД PostgreSQL. С его помощью можно распределять запросы по серверам баз данных в зависимости от их содержания,: например, запросы на чтение будут передаваться на один сервер, а запросы на запись — на другой.

## Алгоритмы балансировки нагрузки

**Алгоритм балансировки нагрузки** – это набор правил, которым следует балансировщик нагрузки для определения наилучшего сервера для каждого из различных клиентских запросов.

При выборе конкретного алгоритма нужно учитывать два фактора:
- специфику конкретного проекта;
- цели, которые планируется достичь.

В числе целей, для достижения которых используется балансировка, нужно выделить следующие:

- **справедливость:**
    нужно гарантировать, чтобы на обработку каждого запроса выделялись системные ресурсы и не допустить возникновения ситуаций, когда один запрос обрабатывается, а все остальные ждут своей очереди;
- **эффективность:**
    все серверы, которые обрабатывают запросы, должны быть заняты на 100%; желательно не допускать ситуации, когда один из серверов простаивает в ожидании запросов на обработку;
- **сокращение времени выполнения запроса:**
    нужно обеспечить минимальное время между началом обработки запроса (или его постановкой в очередь на обработку) и его завершения;
- **сокращение времени отклика:**
    нужно минимизировать время ответа на запрос пользователя.

Очень желательно также, чтобы алгоритм балансировки обладал следующими свойствами:

- **предсказуемость:**
    нужно чётко понимать, в каких ситуациях и при каких нагрузках алгоритм будет эффективным для решения поставленных задач;
- **равномерная загрузка ресурсов системы;**
- **масштабирумость:**
    алгоритм должен сохранять работоспособность при увеличении нагрузки.

Существует несколько алгоритмов балансировки нагрузки, которые используются в современных системах:

**1. Round Robin** - этот алгоритм распределяет запросы между серверами равномерно. Каждому серверу по очереди назначается следующий запрос.  

***Особенности:***
- Прост в реализации и использовании. Использвоание этого алгоритма не требует связи между серверами и поэтому он может использоваться, как для локальной, так и для глобальной балансировки;
- Равномерно распределяет нагрузку между серверами;
- Низкая стоимость данного алгоритма.

***Недостатки:***
- Если один сервер медленнее других, то он будет замедлять всю работу системы;
- Не учитывает загруженность узлов и направляет запросы, как на узлы со 100% загруженностью, так и на узлы с загруженностью в 10-15%, что дает неэффективную и непредсказуемую работу алгоритма;
- Не учитывается количество активных на данный момент подключений.  

**2. Least Connections** - этот алгоритм выбирает сервер с наименьшим количеством активных соединений, и на него отправляется следующий запрос.

***Особенности:***
- Учитывает количество подключений, поддерживаемых серверами в текущий момент времени;
- Динамически выбирает сервер с минимальной загруженностью;
- Обеспечивает более эффективное распределение нагрузки, чем Round Robin.

***Недостатки***
- Если серверы имеют различную производительность, то некоторые серверы могут быть перегружены;
- Недостаточно точно отображает реальную нагрузку на сервер. 

**3. Destination Hash Scheduling и Source Hash Scheduling (IP Hash)** - этот алгоритм основан на IP-адресе клиента. Хеш-функция вычисляет хеш-значение IP-адреса клиента, и на основе этого выбирается сервер для обработки запроса.  

***Особенности:***
- Используется для распределения нагрузки между клиентами на основе IP-адреса;
- Обеспечивает стабильную работу в течение длительного времени.

***Недостатки***
- Наиболее подвержен сбоям, если количество клиентов с одинаковым IP слишком велико;
- Зависит от качества алгоритма хеширования IP-адресов. 

**4. Weighted Round Robin** - с этим алгоритмом серверам присваивается весовой коэффициент в соответствии с его производительностью и мощностью. Чем выше вес сервера, тем больше запросов он получает.  

***Особенности:***
- Позволяет указать вес каждого сервера в зависимости от его производительности;
- Обеспечивает более точное распределение нагрузки по всем доступным серверам.

***Недостатки***
- Требует регулярных проверок и обновлений весов серверов для поддержания эффективности;
- Не учитывает среднее время соединений.  

**5. DNS-балансировка** позволяет работать клиентам с несколькими серверами и повысить их доступность.
Для этого достаточно зарегистрировать несколько IP-адресов на одно доменное имя.

***Особенности:*** 
- Самый простой способ распредедить запросы;
- Балансировка нагрузки DNS полезна для поддержания доступности приложений и балансировки сетевого трафика в глобально распределенном пуле ресурсов.

***Недостатки:***
- Недостаток в том, что DNS запросы кэшируются в браузере пользователя или на уровне операционной системы;
Из-за такого поведения пользователь может обращаться к неработающему серверу.

**6. Sticky Session** алгоритм распределения входящих запросов, при котором соединения передаются на один определенный сервер группы. Пример использования в веб-сервере Nginx. Сессии пользователя могут быть закреплены за конкретным сервером с помощью метода IP hash.

***Особенности:*** 
- Запросы распределяются по серверам на основе IP-адреса клиента;
- Метод гарантирует, что запросы одного и того же клиента будут передаваться на один и тот же сервер;
- Если закрепленный за конкретным адресом сервер недоступен, запроос будет перенаправлен на другой сервер.

***Недостатки:***
- Проблемы с привязкой сессии могут возникнуть, если клиент использует динамический IP.

**7. Random** - этот алгоритм случайным образом выбирает сервер для обработки следующего запроса.  

***Особенности:***
- Прост в реализации;
- Распределяет нагрузку случайным образом.

***Недостатки:***
- Не обеспечивает равномерное распределение нагрузки при большом количестве запросов;
- Случайный выбор серверов может привести к неоптимальному использованию ресурсов.   

Выбор конкретного алгоритма балансировки зависит от требований к системе, включая количество серверов, тип используемой нагрузки, доступные ресурсы и прочие факторы. Необходимо учитывать все эти факторы для решения выбора наилучшего алгоритма.  
